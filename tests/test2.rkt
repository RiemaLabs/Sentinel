#lang rosette
(require (prefix-in anvil:: "../sentinel/anvil.rkt"))
(require (prefix-in ebc:: "../sentinel/ebc.rkt"))

; ===================================
; this tests the evm bytecode parsing
; ===================================

(define sv0 (anvil::serv "127.0.0.1" 8545 "/"))
(define b0 (anvil::eth_getBlockByNumber sv0 14684300))
(define tx0 (list-ref (hash-ref b0 'transactions) 157))
(printf "tx0: ~a\n" tx0)
(define rs0 (hash-ref tx0 'input))
; (printf "rs0: ~a\n" rs0)

; simplified version
; (define rs0 "0x6080604052348015600e575f80fd5b506101438061001c5f395ff3fe608060405234801561000f575f80fd5b5060043610610034575f3560e01c80632e64cec1146100385780636057361d14610056575b5f80fd5b610040610072565b60405161004d919061009b565b60405180910390f35b610070600480360381019061006b91906100e2565b61007a565b005b5f8054905090565b805f8190555050565b5f819050919050565b61009581610083565b82525050565b5f6020820190506100ae5f83018461008c565b92915050565b5f80fd5b6100c181610083565b81146100cb575f80fd5b50565b5f813590506100dc816100b8565b92915050565b5f602082840312156100f7576100f66100b4565b5b5f610104848285016100ce565b9150509291505056fea26469706673582212209a0dd35336aff1eb3eeb11db76aa60a1427a12c1b92f945ea8c8d1dfa337cf2264736f6c634300081a0033")
; (define rs0 "0x60806040819052600080546001600160a01b0319163317905561002190610063565b604051809103906000f08015801561003d573d6000803e3d6000fd5b50600180546001600160a01b0319166001600160a01b0392909216919091179055610070565b610b84806104c983390190565b61044a8061007f6000396000f3fe6080604052600436106100345760003560e01c806313af403514610039578063b8bb98a71461005b578063beb92f551461006e575b600080fd5b34801561004557600080fd5b506100596100543660046102b5565b61008e565b005b6100596100693660046102ed565b610103565b34801561007a57600080fd5b506100596100893660046102b5565b610229565b6000546001600160a01b031633146100e15760405162461bcd60e51b81526020600482015260116024820152703737ba1037bbb732b91031b0b63610b91960791b60448201526064015b60405180910390fd5b600080546001600160a01b0319166001600160a01b0392909216919091179055565b6000546001600160a01b031633146101515760405162461bcd60e51b81526020600482015260116024820152706e6f74206f776e65722063616c6c21723360781b60448201526064016100d8565b34156101c15760015460405163fdfb99cd60e01b81526001600160a01b039091169063fdfb99cd90349061018b90869086906004016103af565b6000604051808303818588803b1580156101a457600080fd5b505af11580156101b8573d6000803e3d6000fd5b50505050505050565b600154604051631d56d26960e11b81526001600160a01b0390911690633aada4d2906101f390859085906004016103af565b600060405180830381600087803b15801561020d57600080fd5b505af1158015610221573d6000803e3d6000fd5b505050505050565b6000546001600160a01b031633146102775760405162461bcd60e51b81526020600482015260116024820152706e6f74206f776e65722063616c6c21723160781b60448201526064016100d8565b600180546001600160a01b0319166001600160a01b0392909216919091179055565b80356001600160a01b03811681146102b057600080fd5b919050565b6000602082840312156102c757600080fd5b6102d082610299565b9392505050565b634e487b7160e01b600052604160045260246000fd5b6000806040838503121561030057600080fd5b61030983610299565b9150602083013567ffffffffffffffff8082111561032657600080fd5b818501915085601f83011261033a57600080fd5b81358181111561034c5761034c6102d7565b604051601f8201601f19908116603f01168101908382118183101715610374576103746102d7565b8160405282815288602084870101111561038d57600080fd5b8260208601602083013760006020848301015280955050505050509250929050565b60018060a01b038316815260006020604081840152835180604085015260005b818110156103eb578581018301518582016060015282016103cf565b818111156103fd576000606083870101525b50601f01601f19169290920160600194935050505056fea2646970667358221220b906c8a521ae0d641b9f69f16d3cc36ce71ffd9ef67920fc1027116d3c5b53ff64736f6c634300080900336080604052600180546001600160a01b031990811632179091556000805490911633179055610b51806100336000396000f3fe6080604052600436106100865760003560e01c8063b2bdfa7b11610059578063b2bdfa7b1461010d578063c0d7865514610149578063c41012c214610169578063edae876f14610189578063fdfb99cd146101a957600080fd5b806313af40351461008b578063217de9e2146100ad5780633aada4d2146100cd578063459a6892146100ed575b600080fd5b34801561009757600080fd5b506100ab6100a636600461085d565b6101bc565b005b3480156100b957600080fd5b506100ab6100c836600461087f565b610246565b3480156100d957600080fd5b506100ab6100e836600461092a565b6103ec565b3480156100f957600080fd5b506100ab6101083660046109bb565b6104fe565b34801561011957600080fd5b5060015461012d906001600160a01b031681565b6040516001600160a01b03909116815260200160405180910390f35b34801561015557600080fd5b506100ab61016436600461085d565b610630565b34801561017557600080fd5b506100ab61018436600461087f565b6106b5565b34801561019557600080fd5b5060005461012d906001600160a01b031681565b6100ab6101b736600461092a565b610785565b6001546001600160a01b03163314806101df57506000546001600160a01b031633145b6102245760405162461bcd60e51b81526020600482015260116024820152706e6f74206f776e65722063616c6c21633160781b60448201526064015b60405180910390fd5b600180546001600160a01b0319166001600160a01b0392909216919091179055565b6001546001600160a01b031633148061026957506000546001600160a01b031633145b6102a95760405162461bcd60e51b81526020600482015260116024820152701b9bdd081bdddb995c8818d85b1b0858cd607a1b604482015260640161021b565b604080518082018252601981527f7472616e7366657228616464726573732c75696e74323536290000000000000060209182015281516001600160a01b0385811660248301526044808301869052845180840390910181526064909201845291810180516001600160e01b031663a9059cbb60e01b179052915160009283928716916103359190610a1a565b6000604051808303816000865af19150503d8060008114610372576040519150601f19603f3d011682016040523d82523d6000602084013e610377565b606091505b50915091508180156103a15750805115806103a15750808060200190518101906103a19190610a36565b6103e55760405162461bcd60e51b815260206004820152601560248201527401026bc9d102a2920a729a322a92fa320a4a622a21605d1b604482015260640161021b565b5050505050565b6001546001600160a01b031633148061040f57506000546001600160a01b031633145b61044f5760405162461bcd60e51b81526020600482015260116024820152706e6f74206f776e65722063616c6c21633560781b604482015260640161021b565b600080836001600160a01b03168360405161046a9190610a1a565b6000604051808303816000865af19150503d80600081146104a7576040519150601f19603f3d011682016040523d82523d6000602084013e6104ac565b606091505b5091509150816104f8576044815110156104c557600080fd5b600481019050808060200190518101906104df9190610a58565b60405162461bcd60e51b815260040161021b9190610acf565b50505050565b6001546001600160a01b031633148061052157506000546001600160a01b031633145b6105615760405162461bcd60e51b81526020600482015260116024820152706e6f74206f776e65722063616c6c21633360781b604482015260640161021b565b6001600160a01b0382166105a9576040516001600160a01b038216904780156108fc02916000818181858888f193505050501580156105a4573d6000803e3d6000fd5b505050565b6040516370a0823160e01b81523060048201526000906001600160a01b038416906370a082319060240160206040518083038186803b1580156105eb57600080fd5b505afa1580156105ff573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106239190610b02565b90506105a4838383610246565b6001546001600160a01b031633148061065357506000546001600160a01b031633145b6106935760405162461bcd60e51b81526020600482015260116024820152703737ba1037bbb732b91031b0b63610b19960791b604482015260640161021b565b600080546001600160a01b0319166001600160a01b0392909216919091179055565b6001546001600160a01b031632146107035760405162461bcd60e51b81526020600482015260116024820152706e6f74206f776e65722063616c6c21633760781b604482015260640161021b565b60405163a9059cbb60e01b81526001600160a01b0383811660048301526024820183905284169063a9059cbb90604401602060405180830381600087803b15801561074d57600080fd5b505af1158015610761573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906104f89190610a36565b6001546001600160a01b03163314806107a857506000546001600160a01b031633145b6107e85760405162461bcd60e51b81526020600482015260116024820152703737ba1037bbb732b91031b0b63610b19b60791b604482015260640161021b565b600080836001600160a01b031634846040516108049190610a1a565b60006040518083038185875af1925050503d80600081146104a7576040519150601f19603f3d011682016040523d82523d6000602084013e6104ac565b80356001600160a01b038116811461085857600080fd5b919050565b60006020828403121561086f57600080fd5b61087882610841565b9392505050565b60008060006060848603121561089457600080fd5b61089d84610841565b92506108ab60208501610841565b9150604084013590509250925092565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff811182821017156108fa576108fa6108bb565b604052919050565b600067ffffffffffffffff82111561091c5761091c6108bb565b50601f01601f191660200190565b6000806040838503121561093d57600080fd5b61094683610841565b9150602083013567ffffffffffffffff81111561096257600080fd5b8301601f8101851361097357600080fd5b803561098661098182610902565b6108d1565b81815286602083850101111561099b57600080fd5b816020840160208301376000602083830101528093505050509250929050565b600080604083850312156109ce57600080fd5b6109d783610841565b91506109e560208401610841565b90509250929050565b60005b83811015610a095781810151838201526020016109f1565b838111156104f85750506000910152565b60008251610a2c8184602087016109ee565b9190910192915050565b600060208284031215610a4857600080fd5b8151801515811461087857600080fd5b600060208284031215610a6a57600080fd5b815167ffffffffffffffff811115610a8157600080fd5b8201601f81018413610a9257600080fd5b8051610aa061098182610902565b818152856020838501011115610ab557600080fd5b610ac68260208301602086016109ee565b95945050505050565b6020815260008251806020840152610aee8160408501602087016109ee565b601f01601f19169190910160400192915050565b600060208284031215610b1457600080fd5b505191905056fea26469706673582212201b8e42e8db9ffee93476f276a24c693dd7b724662742a4f1e911d7920ed7730d64736f6c63430008090033")

(define ebc0 (ebc::hexstr->ebc rs0))
; (printf "ebc0: ~a\n" ebc0)

(define hs0 (ebc::ebc->hexstr ebc0))
; (printf "hs0: ~a\n" hs0)

(printf "check: ~a\n" (equal? hs0 rs0))